from collections.abc import Iterator
from copy import deepcopy
from dataclasses import dataclass
from typing import Self


Couple = tuple[int, int]
Position = Couple
RIGHT_TURN = {
    (0, 1): (1, 0),
    (1, 0): (0, -1),
    (0, -1): (-1, 0),
    (-1, 0): (0, 1),
}


@dataclass
class Guard:
    direction: Couple
    position: Position

    def is_found(self) -> bool:
        return self.direction != (0, 0)

    @classmethod
    def not_found(cls) -> Self:
        return cls(direction=(0, 0), position=(0, 0))

    def meet(self, direction: Couple, position: Position) -> Self:
        if self.is_found():
            raise ValueError(f"Guard was already found at position {self.position}")
        return type(self)(direction=direction, position=position)

    def advance(self) -> Self:
        return type(self)(
            position=tuple(p + d for p, d in zip(self.position, self.direction)),
            direction=self.direction
        )

    def turn_right(self) -> Self:
        return type(self)(
            position=self.position,
            direction=RIGHT_TURN[self.direction],
        )

    def __hash__(self) -> int:
        return hash((self.direction, self.position))


@dataclass
class Lab:
    shape: Couple
    obstacles: set[Position]
    guard: Guard

    @classmethod
    def parse_map(cls, map_: str) -> Self:
        map = [list(line) for line in map_.split("\n")]
        assert map
        assert all(len(row) == len(map[0]) for row in map)

        shape = (len(map), len(map[0]))
        obstacles = set()
        guard = Guard.not_found()
        for i_row, row in enumerate(map):
            for i_col, ch in enumerate(row):
                match ch:
                    case "#":
                        obstacles.add((i_row, i_col))
                    case "^":
                        guard = guard.meet(direction=(-1, 0), position=(i_row, i_col))
                    case ">":
                        guard = guard.meet(direction=(0, 1), position=(i_row, i_col))
                    case "v":
                        guard = guard.meet(direction=(1, 0), position=(i_row, i_col))
                    case "<":
                        guard = guard.meet(direction=(0, -1), position=(i_row, i_col))
                    case ".":
                        pass
                    case _:
                        raise ValueError(
                            f"Unknown character at position ({i_row}, {i_col})"
                        )
        assert guard.is_found()
        return cls(shape=shape, obstacles=obstacles, guard=guard)

    def step(self) -> Guard:
        guard = self.guard.advance()
        if guard.position in self.obstacles:
            guard = self.guard.turn_right()
        self.guard = guard
        return self.guard

    def has_guard_exited(self) -> bool:
        return any(p < 0 or p >= s for p, s in zip(self.guard.position, self.shape))

    def walk_guard_out(self) -> Iterator[Position]:
        guard_orig = self.guard
        try:
            while not self.has_guard_exited():
                yield self.guard.position
                self.step()
        finally:
            self.guard = guard_orig

    def with_new_obstacle(self, obstacle: Position) -> Self:
        assert obstacle != self.guard.position
        clone = deepcopy(self)
        clone.obstacles.add(obstacle)
        return clone

    def would_guard_loop(self) -> bool:
        guard_orig = self.guard
        try:
            visited = set()
            while not self.has_guard_exited():
                if self.guard in visited:
                    return True
                visited.add(self.guard)
                self.step()
            return False
        finally:
            self.guard = guard_orig

    def iter_obstacles_inducing_loop(self, tqdm=lambda x: x) -> Iterator[Position]:
        visited = set()
        for position in tqdm([
            pos
            for pos in set(deepcopy(self).walk_guard_out())
            if pos != self.guard.position
        ]):
            if (
                position not in visited
            ) and self.with_new_obstacle(position).would_guard_loop():
                yield position
                visited.add(position)


INPUT = """\
......#........#.............#.##..........................................#.......#...#........#......................#..........
.......................#...#................................#..#.........................................#.....#.....#............
.......................................#.................#..................#....#........................................#.......
.............#...................#.#...............................#....#....#.#.......................................#..#.......
...............................#........##.#..............................#..............................#..#...#..#..............
........................#......................................................................................#..#...............
............................#..........#.......#...................#.....#..................#.....................#..##...........
......................................................##........................#..............#........#..............#..#...#...
............................#.............................................##..........................................#...........
..........#............#....................................#...........#......................................................#..
....#......#.........................................#.......#...............................#..#.##..................#........#..
........................#.#..........##.#..........#......#.......#............................................................#..
..........................................................................................#.#..........................#..........
.............................#............#.......................#................#....................................#.........
...................................#.........................#.............#......#...#................................#.....#....
..........#..................#..#.....................#...#...#.........................................#................#........
....#....#...........#...#..........................................#.............#..#......#................#.....#..............
....................................................................................#......#....##..##....#.......................
...........................#......................#.........##................#............#.......................#...#..........
...........................#....................#............................................#........#.........................#.
..#......#.......#.#...........................#......#....#.#...#.............................#............#..............#......
.......#................#...................................#.........................#..................................#........
..................................................................#...........................................................#...
......................#....#........................................................................................#.............
...#..................#.......#......................................................................#.#....................#.....
................#....................................#.........#..#.........................#...............#.......#.............
.......................................#.................#..................................#...#...........#.....................
....#.....###..................#........#...#..............#............#...............................................#.........
...................#.......................................................#...................................#..................
....#......................................#...##.....#........#......#......#..........................................#.........
......................#............#...............#................#...............................#.............................
......................#..............................................#...........#............#.................................#.
#.#..............................#..#......#.............#.......#......................#...........#........#..........#.........
....#....#.......................................#.......................................................#........................
.......#............................#...........................#.........................#...............#.......................
.....................................#........#.....#........#.......................#...............#..........................#.
....#.......................................#........#......................................................#.................#...
............#..............#...#.......#..#.................................................................................##...#
...#..................#...................#....#............................................................................#.....
.....#....................#...............#.............................................#.....#...............................#...
..............................#.......................#.................#.......................................................#.
.........#....................#..............................................................................#.................#..
......#..................#.........................#.......#.....#...........#....#...................................#......#....
.........#...#......................#......#.................#.........................................#...................#......
....#....#.................................#..#..#........#............................................#.......#..................
....................#...........................#...#............#...........................#....................................
................#................#....#.......................................#....#..........#.#.#..........#....................
....#............................#...................................#.....................................................#.#....
....................................#............#......................#......................##.....................#.......#...
.........................#...................................#.....#................................................#.............
...........#.#..#............................................................................#.#..................................
....#......#.#..................................................#..#....#...#..#...................................#..............
#.........................#.#.................................................................#.#.............................#...
..................#...#........#.......................................................#....#..............................#...#..
.........#..........#.............................................................................................#...............
....................................................................#.......................#..#............#............#........
.................#.................#.............................................#..................................#.............
.#...................................................................................................#................#...........
...#....#.#.#.........#............#..............................................................................................
..................#...#......................................#...#.............#....#....#................#.......................
.....#................................##....................................................................#.....................
............#..................#......#....................#.....#.#.........................##............#............#.......#.
............................#..#.................#.............................................#..................................
............#...............#..........................................................#........#.................................
.......#.......#.......................................##..............##.........................................................
....................#.........#.....#..............#....#.......................................................#.................
...#............................................................#.............................................#...#............#..
....#..............................#...............................#..........................................#...................
............................................................................................................#....................#
..#.............................................................................................................#............#....
..........#...............#.........................................................#...........#.................................
...............#.....................#....................................#....................#.....#...#.....................#..
.#......#.........................................................................................#..#............................
......#..............#........#........#........#.........................................................#.......................
............................#...........#..#.............................................................................#........
..................#..............#.......................................#.........#...............#.....................#.#......
...........................................#.##...................................................................................
.......................#.............................................................................................#............
..........#................................#......#..............................#.................#........#......#.#.........#..
#.......#........................#.....#..........##......#................#......................................#..#..#......#..
........................##........................#....................#......................................#.................#.
..........................#.#........................................................................................#............
..........#.........#.....#......#............#..#................................................##.................#............
........#.....#............##...........................................#..#...............................................#.....#
..............#.......#......................#.....#.......................#.........#........#.................#...#....#........
..............#.................................#.................................................##..............................
................................#........#...........#........................................................#...................
..#.#..................#....#......#..............................#.....#....#.#.............#...............................#....
.....................................................................#......#.........#.......#.........................#....#..#.
.#..........................#.....#...........................................##..^.#..........................#....#....#....#...
...........................#..#................................................................#...#........#.........#...........
......#.................#..............#................#.........#........................#..#........#......#...................
.....#..................#..........#............................................................................#.#...........#...
..........#.........#.................................#......#....#...............#.....................#...#.....................
...........#.......#...........#..#...............#...#..............#...........................................#................
..............................................................#...................................................................
................#..............#.....................#.......#.....................................................#..............
#................#.......#.#..............................#..........................#.............................#..........#...
.#...#.........##..........#......................#....#.........#....................#...............................#.....#.....
....#......#.................#....................................#...............................................................
......#..........#...............................................................#....#...............#.....#.##..................
............................................................#..................#..#...................#.....#.....................
......................#.......#...#....#....................................#.............................#............#..........
.#.............#.....................#...............#.......#...............##.....#..................##...#.....................
........#........................................................###.#..........................................#.................
...##.#................................................................................................#..........................
.............##................#.............#....................#....#......................#........................#.....#....
..#.......#............................................#...............................................#..........................
.................#....#.......................................................#............#..#........................#.......#.#
...#..#......................#............#........#...........................................................................#..
....................................#.......................#.....................................#.....#..#......................
.#...............#......#...........#.....#........##....#.......#.....#...................................................#......
...................#...#............................#..##........#...........................#...........#........................
....................#.#.....................................................................................#......#..............
....#...........#....#...#...#.....................#............................................#..............#..................
......#.#......#................#......................................#...............#..........................................
.......#.#................#..............#.....................#.#......#..................#......................................
.....#................................#..............#.......#......##........#................................#..........#.......
.....................................#......#.........#...#.....#..........#..........................#...........................
......#.......#............................................................#..#....................#...............#.........#....
.........................#...........#.............#......#..#..............................................................#.....
.........#.......##.....#....................................#.....#..............#......#.......#..................##.........#..
.........................#...................#...#.....#...........................................#.................#..#.........
...........#..........#.......................................................................................................#..#
.....#................................................#...........................................................#....#..........
..............#.................................#.............#.........................................................#.........
............#.........................................................#.....#...............................................#.....
..................................................#.................#.............................#....#...#.........#.......#....
........#................#................................................................#................#....................#.
..................##............................###.........#.......#................#........#......#............#...............\
"""
